<div class="row">
    <div class="col-sm-6">
        <div id='map1'></div>
    </div>
    <div class="col-sm-6">
        <div class='dayBar'>
            <p id='maxDay'></p>
            <span id='prevDay' class="dayBtn glyphicon glyphicon-triangle-left"></span>
            <span id='dayTitle'>第1天</span>
            <span id='nextDay' class="dayBtn glyphicon glyphicon-triangle-right"></span>
        </div>
        <div id='panel'></div>
    </div>
</div>
<style type="text/css">
#map1 {
    width: 100%;
    height: 100vh;
}
.dayBar{
    font-size: 16px;
    width: 100%;
    padding: 10px;
}
.dayBtn {
    cursor: pointer;
}
.time_title {
    border-top: 0.5px solid #F0F0F0;
    height: 40px;
    margin: 0;
    padding: 3px;
}

.morning {
    background: linear-gradient(to bottom, #00FFFF, white);
}

.noon {
    background: linear-gradient(to bottom, #FFFFAA, white);
}

.afternoon {
    background: linear-gradient(to bottom, #FFC78E, #FFE4CA, white);
}

.night {
    background: linear-gradient(to bottom, #28004D, #5A5AAD, white);
    color: white;
}
</style>
<script type="text/javascript">
var map1,
    modes = [],
    service,
    places = [],
    details =[],
    ids=[],
    promises=[],
    pagenow=0
newMap()
//DisplaySchedule();
function newMap() {
    console.log('newMap,searchBox');
    map1 = new google.maps.Map(document.getElementById('map1'), {
        center: {
            lat: 23.6,
            lng: 121.2
        },
        zoom: 8,
        disableDefaultUI: true,
        disableDoubleClickZoom: true
            //scrollwheel: false
    })
    service = new google.maps.places.PlacesService(map1)
    console.log(_display_place)
    $('#panel').html(_display_place)
    let panel = $('#panel'),
        day = panel.find('.time_line').length
    _panel(panel,day)
    panel.find('.time_place').each(function(i) {
        let id=$(this).attr('id'),
            mode = $(this).attr('mode'),
            del = $(this).find('#delList'),
            first = $(this).attr('placeId'),
            last = panel.find('.time_place').eq(i + 1).attr('placeId')
        del.remove()
        $(this).find('.select').empty().text(mode)
        if (mode)
            modes.push(mode)
        else
            modes.push('none')     
        places.push(first)

        promises.push(placeDetail(first)) 
    })
    Promise.all(promises).then(()=>{
        console.log(places)
        for(let i=0;i<places.length;i++) {
            if(modes[i]!='none'){
                 let first=_findDetail(places[i]),
                last=_findDetail(places[i+1])
                DisplayRoutes(first,last , modes[i])
            }           
        }
    })
    DayBtn(day)
}
function _panel(panel,day){
    $('#maxDay').text(day+'日遊')
    panel.find('.time_line').css({display:'block',opacity:'1'})
}
function _findDetail(placeId){
    for(let i=0;i<details.length;i++){
        if(details[i].id==placeId)
            return details[i].place
    }
}
function DayBtn(day){
    $('#panel').find('.time_line').css('display','none')
        .first().css('display','block')
    $('#prevDay').on('click',function(){
        if(pagenow!=0)
            pagenow--
        _pageEvent()
    })
    $('#nextDay').on('click',function(){
        if(pagenow!=day-1)
            pagenow++
        _pageEvent()
    })

}
function _pageEvent(){
    let days=$('#panel').find('.time_line')
    days.css('display','none')
    days.eq(pagenow).css('display','block')
    $('#dayTitle').text('第'+(pagenow+1)+'天')
}
function placeDetail(placeId) {
    return new Promise(function(resolve,reject){
        service.getDetails({placeId: placeId},function(result,status) {
            if(status=='OK'){
                console.log('detail')
                details.push({id:placeId,place:result})
                resolve()
            }
        })
    })	
}

function DisplayRoutes(first, last, mode) {
    console.log('DisplayRoutes')
    let directions = new google.maps.DirectionsService(),
        renderer=new google.maps.DirectionsRenderer({map:map1}),
        request = {
            origin: first.geometry.location,
            destination: last.geometry.location,
            //waypoints:waypoints,
            optimizeWaypoints: true,
            travelMode: mode
            // transitOptions: {
            //     //modes: ['BUS'],
            //     //routingPreference: 'FEWER_TRANSFERS'
            // }
        }
    directions.route(request,function(result,status){
        if(status=='OK'){
            console.log('render')
            renderer.setOptions({ suppressMarkers: true })
            renderer.setDirections(result)
        }
    })
}

</script>
